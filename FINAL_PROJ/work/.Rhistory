arrange(desc(total))
crime_count <- geocrime %>%
group_by(div_id) %>%
summarize(num = n())
geocount <- st_join(geodiv, crime_count, by = "div_id")
plot(geocount["num"])
geocrime %>%
mutate(month = lubridate::month(newdate)) %>%
group_by(month) %>%
count(crime_category) %>%
ggplot(aes(month, n)) +
geom_line() +
facet_wrap(vars(crime_category))
geocrime %>%
mutate(day = weekdays(newdate)) %>%
group_by(day) %>%
count(crime_category) %>%
ggplot(aes(day, n)) +
geom_col() +
facet_wrap(vars(crime_category))
geocrime %>%
mutate(month = lubridate::month(newdate),
year = lubridate::year(newdate)) %>%
mutate(month_year = as.factor((year*100)+month)) %>%
group_by(month_year) %>%
count(crime_category) %>%
ggplot(aes(month_year, n)) +
geom_col() +
scale_x_discrete()+
facet_wrap(vars(crime_category))
crime_count2 <- geocrime %>%
group_by(div_id, crime_category) %>%
summarize(num = n()) %>%
spread(crime_category, num)
geocount2 <- st_join(geodiv, crime_count2, by = "div_id")
plot(geocount2[10:18])
crimesdiv = st_read("crimesdiv.geojson")
df.2018 <- crimesdiv %>% filter(year == "2018")
df.2019 <- crimesdiv %>% filter(year == "2019")
div_id_uniq <- unique(df.2018$div_id)
length(div_id_uniq) # for 2018, 485 unique div id
df.2018.1 <- df.2018 %>%
group_by(div_id) %>%
summarise(avg_inc = mean(avg_income), n = n())
sum(df.2018.1$n)
# n() gave the count, as each row is a "crime" ... but, if there are repeating incident numbers, let's try to pare down by unique incident number
#Year 2018
df.2018.2 <- df.2018 %>% as.data.frame %>%
group_by(div_id) %>%
summarise(avg_inc = mean(avg_income), n = length(unique(incident_number)))
df.2018.2$div_id <- as.character(df.2018.2$div_id)
# turn div_id into row names
df.2018.2 <- df.2018.2 %>%
column_to_rownames('div_id')
#Year 2019
df.2019.2 <- df.2019 %>% as.data.frame %>%
group_by(div_id) %>%
summarise(avg_inc = mean(avg_income), n = length(unique(incident_number)))
df.2019.2$div_id <- as.character(df.2019.2$div_id)
# turn div_id into row names
df.2019.2 <- df.2019.2 %>%
column_to_rownames('div_id')
sum(df.2018.2$n)
distance <- get_dist(df.2018.2)
fviz_dist(distance, gradient = list(low = "#00AFBB", mid = "white", high = "#FC4E07"))
# Scale the data so the kmeans algorithm doesn't give too much weight to outliers
df.2018.2.prescale <- df.2018.2
df.2018.2 <- scale(df.2018.2)
df.2019.2.prescale <- df.2019.2
df.2019.2 <- scale(df.2019.2)
k2 <- kmeans(df.2018.2, centers=2, nstart=25)
str(k2)
fviz_cluster(k2, data=df.2018.2)
k3 <- kmeans(df.2018.2, centers = 3, nstart = 25)
k4 <- kmeans(df.2018.2, centers = 4, nstart = 25)
k5 <- kmeans(df.2018.2, centers = 5, nstart = 25)
# plots to compare
p1 <- fviz_cluster(k2, geom = "point", data = df.2018.2) + ggtitle("k = 2")
p2 <- fviz_cluster(k3, geom = "point",  data = df.2018.2) + ggtitle("k = 3")
p3 <- fviz_cluster(k4, geom = "point",  data = df.2018.2) + ggtitle("k = 4")
p4 <- fviz_cluster(k5, geom = "point",  data = df.2018.2) + ggtitle("k = 5")
grid.arrange(p1, p2, p3, p4, nrow = 2)
set.seed(123)
fviz_nbclust(df.2018.2, kmeans, method = "wss")
set.seed(123)
fviz_nbclust(df.2018.2, kmeans, method = "silhouette")
set.seed(123)
gap_stat <- clusGap(df.2018.2, FUN = kmeans, nstart = 25,
K.max = 10, B = 50)
fviz_gap_stat(gap_stat)
# Extracting results going with 5
set.seed(123)
final.18 <- kmeans(df.2018.2, 5, nstart = 25, algorithm="Hartigan-Wong")
final.19 <- kmeans(df.2019.2, 5, nstart = 25, algorithm="Hartigan-Wong")
# Extracting results going with 4
set.seed(123)
final.18_pam <- pam(df.2018.2, 4, metric = "euclidean", stand = FALSE)
# Basic plot
fviz_cluster(final.18_pam, data = df.2018.2)
clusplot(df.2018.2, final.18$cluster, color=T, shade=T, labels=1, lines=0)
# Basic plot
fviz_cluster(final.18, data = df.2018.2)
str(final.18)
df.2018.2.prescale <- as.data.frame(df.2018.2.prescale)
df.2018.2.prescale %>%
mutate(Cluster = final.18$cluster) %>%
group_by(Cluster) %>%
summarise_all("mean")
df.2019.2.prescale <- as.data.frame(df.2019.2.prescale)
df.2019.2.prescale %>%
mutate(Cluster = final.19$cluster) %>%
group_by(Cluster) %>%
summarise_all("mean")
dfX.18 <- data.frame('div_id' = names(final.18$cluster), 'cluster' = final.18$cluster)
rownames(dfX.18) <- NULL
dfX.19 <- data.frame('div_id' = names(final.19$cluster), 'cluster' = final.19$cluster)
rownames(dfX.19) <- NULL
# Join on div_id to add cluster by each subdivision
df.2018$div_id <- as.character(df.2018$div_id)
df.2018 <- left_join(df.2018, dfX.18, by='div_id')
df.2019$div_id <- as.character(df.2019$div_id)
df.2019 <- left_join(df.2019, dfX.19, by='div_id')
(map <- get_map(c(left = -78.95, bottom = 35.64, right = -78.72, top = 35.87)))
ggmap(map) +
geom_point(data=df.2018, aes(x=lon, y=lat, color=factor(cluster, labels = c("Low income, low crime count", "Medium crime count", "High crime count", "High income, low crime count", "Medium income, low crime count"))), size=0.5) +
xlab(expression(paste("Longitude (", degree,"W)"))) +
ylab(expression(paste("Latitude (", degree,"N)"))) +
labs(color = "Clusters") +
ggtitle("Total Crimes Clustered by Subdivision (2018)")
(map <- get_map(c(left = -78.95, bottom = 35.64, right = -78.72, top = 35.87)))
ggmap(map) +
geom_point(data=df.2019, aes(x=lon, y=lat, color=factor(cluster, labels = c("Low income, low crime count", "High crime count", "Medium income, low crime count", "Medium crime count", "High income, low crime count"))), size=0.5) +
xlab(expression(paste("Longitude (", degree,"W)"))) +
ylab(expression(paste("Latitude (", degree,"N)"))) +
labs(color = "Clusters") +
ggtitle("Total Crimes Clustered by Subdivision (2019)")
df.18 <- crimesdiv %>% filter(year == "2018")
df.19 <- crimesdiv %>% filter(year == "2019")
df.20 <- crimesdiv %>% filter(year == "2020")
# Create wide DF to then capture the totals for theft and assault
# Year: 2018
df.18.wide <- spread(df.18, offensecategory, ucr)
colnames(df.18.wide)[which(names(df.18.wide) == "Aggravated Assault")] <- "Ag.As"
colnames(df.18.wide)[which(names(df.18.wide) == "Simple Assault")] <- "Sim.As"
colnames(df.18.wide)[which(names(df.18.wide) == "Stolen Property")] <- "Sto.Prop"
colnames(df.18.wide)[which(names(df.18.wide) == "Larceny")] <- "Larc"
colnames(df.18.wide)[which(names(df.18.wide) == "Motor Vehicle Theft")] <- "Mo.Ve.Th"
df.18.wide$Ag.As <- ifelse(is.na(df.18.wide$Ag.As), 0, 1)
df.18.wide$Sim.As <- ifelse(is.na(df.18.wide$Sim.As), 0, 1)
df.18.wide$Sto.Prop <- ifelse(is.na(df.18.wide$Sto.Prop), 0, 1)
df.18.wide$Larc <- ifelse(is.na(df.18.wide$Larc), 0, 1)
df.18.wide$Mo.Ve.Th <- ifelse(is.na(df.18.wide$Mo.Ve.Th), 0, 1)
df.19.wide <- spread(df.19, offensecategory, ucr)
colnames(df.19.wide)[which(names(df.19.wide) == "Aggravated Assault")] <- "Ag.As"
colnames(df.19.wide)[which(names(df.19.wide) == "Simple Assault")] <- "Sim.As"
colnames(df.19.wide)[which(names(df.19.wide) == "Stolen Property")] <- "Sto.Prop"
colnames(df.19.wide)[which(names(df.19.wide) == "Larceny")] <- "Larc"
colnames(df.19.wide)[which(names(df.19.wide) == "Motor Vehicle Theft")] <- "Mo.Ve.Th"
df.19.wide$Ag.As <- ifelse(is.na(df.19.wide$Ag.As), 0, 1)
df.19.wide$Sim.As <- ifelse(is.na(df.19.wide$Sim.As), 0, 1)
df.19.wide$Sto.Prop <- ifelse(is.na(df.19.wide$Sto.Prop), 0, 1)
df.19.wide$Larc <- ifelse(is.na(df.19.wide$Larc), 0, 1)
df.19.wide$Mo.Ve.Th <- ifelse(is.na(df.19.wide$Mo.Ve.Th), 0, 1)
df.20.wide <- spread(df.20, offensecategory, ucr)
colnames(df.20.wide)[which(names(df.20.wide) == "Aggravated Assault")] <- "Ag.As"
colnames(df.20.wide)[which(names(df.20.wide) == "Simple Assault")] <- "Sim.As"
colnames(df.20.wide)[which(names(df.20.wide) == "Stolen Property")] <- "Sto.Prop"
colnames(df.20.wide)[which(names(df.20.wide) == "Larceny")] <- "Larc"
colnames(df.20.wide)[which(names(df.20.wide) == "Motor Vehicle Theft")] <- "Mo.Ve.Th"
df.20.wide$Ag.As <- ifelse(is.na(df.20.wide$Ag.As), 0, 1)
df.20.wide$Sim.As <- ifelse(is.na(df.20.wide$Sim.As), 0, 1)
df.20.wide$Sto.Prop <- ifelse(is.na(df.20.wide$Sto.Prop), 0, 1)
df.20.wide$Larc <- ifelse(is.na(df.20.wide$Larc), 0, 1)
df.20.wide$Mo.Ve.Th <- ifelse(is.na(df.20.wide$Mo.Ve.Th), 0, 1)
df.18.v2 <- df.18.wide %>% as.data.frame %>%
group_by(div_id) %>%
summarise(Avg.Inc = mean(avg_income),
Ag.Assault=sum(Ag.As),
Sim.Assault=sum(Sim.As),
Sto.Prop=sum(Sto.Prop),
Larc=sum(Larc),
Mo.Ve.Th=sum(Mo.Ve.Th))
df.18.v2$div_id <- as.character(df.18.v2$div_id)
# turn div_id into row names
df.18.v2 <- df.18.v2 %>%
column_to_rownames('div_id')
df.18.v2$Total.Assault <- df.18.v2$Ag.Assault + df.18.v2$Sim.Assault
df.18.v2$Total.Theft <- df.18.v2$Larc + df.18.v2$Sto.Prop + df.18.v2$Mo.Ve.Th
df.18.v2.TotAs <- df.18.v2[,c("Avg.Inc", "Total.Assault")]
df.18.v2.TotTh <- df.18.v2[,c("Avg.Inc", "Total.Theft")]
dim(df.18.v2.TotAs)
df.19.v2 <- df.19.wide %>% as.data.frame %>%
group_by(div_id) %>%
summarise(Avg.Inc = mean(avg_income),
Ag.Assault=sum(Ag.As),
Sim.Assault=sum(Sim.As),
Sto.Prop=sum(Sto.Prop),
Larc=sum(Larc),
Mo.Ve.Th=sum(Mo.Ve.Th))
df.19.v2$div_id <- as.character(df.19.v2$div_id)
# turn div_id into row names
df.19.v2 <- df.19.v2 %>%
column_to_rownames('div_id')
df.19.v2$Total.Assault <- df.19.v2$Ag.Assault + df.19.v2$Sim.Assault
df.19.v2$Total.Theft <- df.19.v2$Larc + df.19.v2$Sto.Prop + df.19.v2$Mo.Ve.Th
df.19.v2.TotAs <- df.19.v2[,c("Avg.Inc", "Total.Assault")]
df.19.v2.TotTh <- df.19.v2[,c("Avg.Inc", "Total.Theft")]
dim(df.19.v2.TotAs)
df.20.v2 <- df.20.wide %>% as.data.frame %>%
group_by(div_id) %>%
summarise(Avg.Inc = mean(avg_income),
Ag.Assault=sum(Ag.As),
Sim.Assault=sum(Sim.As),
Sto.Prop=sum(Sto.Prop),
Larc=sum(Larc),
Mo.Ve.Th=sum(Mo.Ve.Th))
df.20.v2$div_id <- as.character(df.20.v2$div_id)
# turn div_id into row names
df.20.v2 <- df.20.v2 %>%
column_to_rownames('div_id')
df.20.v2$Total.Assault <- df.20.v2$Ag.Assault + df.20.v2$Sim.Assault
df.20.v2$Total.Theft <- df.20.v2$Larc + df.20.v2$Sto.Prop + df.20.v2$Mo.Ve.Th
df.20.v2.TotAs <- df.20.v2[,c("Avg.Inc", "Total.Assault")]
df.20.v2.TotTh <- df.20.v2[,c("Avg.Inc", "Total.Theft")]
dim(df.20.v2.TotAs)
# Scale the data
# Save the data in prescale values for later use
df.18.v2.TotAs.Prescale <- df.18.v2.TotAs
df.18.v2.TotTh.Prescale <- df.18.v2.TotTh
df.18.v2.TotAs <- scale(df.18.v2.TotAs)
df.18.v2.TotTh <- scale(df.18.v2.TotTh)
df.19.v2.TotAs.Prescale <- df.19.v2.TotAs
df.19.v2.TotTh.Prescale <- df.19.v2.TotTh
df.19.v2.TotAs <- scale(df.19.v2.TotAs)
df.19.v2.TotTh <- scale(df.19.v2.TotTh)
df.20.v2.TotAs.Prescale <- df.20.v2.TotAs
df.20.v2.TotTh.Prescale <- df.20.v2.TotTh
df.20.v2.TotAs <- scale(df.20.v2.TotAs)
df.20.v2.TotTh <- scale(df.20.v2.TotTh)
# Total Assault
set.seed(123)
kclusts <-
tibble(k = 1:9) %>%
mutate(
kclust = map(k, ~kmeans(df.18.v2.TotAs, .x)),
tidied = map(kclust, tidy),
glanced = map(kclust, glance),
augmented = map(kclust, augment, df.18.v2.TotAs)
)
clusters <-
kclusts %>%
unnest(cols = c(tidied))
assignments <-
kclusts %>%
unnest(cols = c(augmented))
clusterings <-
kclusts %>%
unnest(cols = c(glanced))
p1 <-
ggplot(assignments, aes(x = Avg.Inc, y = Total.Assault)) +
geom_point(aes(color = .cluster), alpha = 0.8) +
facet_wrap(~ k)
p2 <- p1 + geom_point(data = clusters, size = 10, shape = "x")
p2
ggplot(clusterings, aes(k, tot.withinss)) +
geom_line() +
geom_point()
df.18.v2.TotAs.final <- kmeans(df.18.v2.TotAs, centers=3, nstart=25)
str(df.18.v2.TotAs.final)
df.19.v2.TotAs.final <- kmeans(df.19.v2.TotAs, centers=3, nstart=25)
str(df.19.v2.TotAs.final)
df.20.v2.TotAs.final <- kmeans(df.20.v2.TotAs, centers=3, nstart=25)
str(df.20.v2.TotAs.final)
# Year: 2018
df.18.v2.TotAs.Prescale <- as.data.frame(df.18.v2.TotAs.Prescale)
df.18.v2.TotAs.Prescale %>%
mutate(Cluster = df.18.v2.TotAs.final$cluster) %>%
group_by(Cluster) %>%
summarise_all("mean")
dfX.18 <- data.frame('div_id' = names(df.18.v2.TotAs.final$cluster), 'cluster'=df.18.v2.TotAs.final$cluster)
rownames(dfX.18) <- NULL
# Year: 2019
df.19.v2.TotAs.Prescale <- as.data.frame(df.19.v2.TotAs.Prescale)
df.19.v2.TotAs.Prescale %>%
mutate(Cluster = df.19.v2.TotAs.final$cluster) %>%
group_by(Cluster) %>%
summarise_all("mean")
dfX.19 <- data.frame('div_id' = names(df.19.v2.TotAs.final$cluster), 'cluster'=df.19.v2.TotAs.final$cluster)
rownames(dfX.19) <- NULL
# Year: 2020
df.20.v2.TotAs.Prescale <- as.data.frame(df.20.v2.TotAs.Prescale)
df.20.v2.TotAs.Prescale %>%
mutate(Cluster = df.20.v2.TotAs.final$cluster) %>%
group_by(Cluster) %>%
summarise_all("mean")
dfX.20 <- data.frame('div_id' = names(df.20.v2.TotAs.final$cluster), 'cluster'=df.20.v2.TotAs.final$cluster)
rownames(dfX.20) <- NULL
# Join on div_id to add cluster by each subdivision
# Year: 2018
df.18.assault <- df.18 %>% filter(offensecategory == "Simple Assault" | offensecategory == "Aggravated Assault")
df.18.assault$div_id <- as.character(df.18.assault$div_id)
df.18.assault <- left_join(df.18.assault, dfX.18, by='div_id')
# Year: 2019
df.19.assault <- df.19 %>% filter(offensecategory == "Simple Assault" | offensecategory == "Aggravated Assault")
df.19.assault$div_id <- as.character(df.19.assault$div_id)
df.19.assault <- left_join(df.19.assault, dfX.19, by='div_id')
# Year: 2020
df.20.assault <- df.20 %>% filter(offensecategory == "Simple Assault" | offensecategory == "Aggravated Assault")
df.20.assault$div_id <- as.character(df.20.assault$div_id)
df.20.assault <- left_join(df.20.assault, dfX.20, by='div_id')
# Year: 2018
(map <- get_map(c(left = -78.95, bottom = 35.64, right = -78.72, top = 35.87)))
ggmap(map) +
geom_point(data=df.18.assault, aes(x=lon, y=lat, color=factor(cluster, labels = c("High Income, Low Assault Count", "High Assault Count", "Low Income, Low Assault Count"))), size=1) +
xlab(expression(paste("Longitude (", degree,"W)"))) +
ylab(expression(paste("Latitude (", degree,"N)"))) +
labs(color = "Clusters") +
ggtitle("Assaults Clustered by Subdivision (2018)")
# Year: 2019
(map <- get_map(c(left = -78.95, bottom = 35.64, right = -78.72, top = 35.87)))
ggmap(map) +
geom_point(data=df.19.assault, aes(x=lon, y=lat, color=factor(cluster, labels = c("High Income, Low Assault Count", "High Assault Count", "Low Income, Low Assault Count"))), size=1) +
xlab(expression(paste("Longitude (", degree,"W)"))) +
ylab(expression(paste("Latitude (", degree,"N)"))) +
labs(color = "Clusters") +
ggtitle("Assaults Clustered by Subdivision (2019)")
# Year: 2020
(map <- get_map(c(left = -78.95, bottom = 35.64, right = -78.72, top = 35.87)))
ggmap(map) +
geom_point(data=df.20.assault, aes(x=lon, y=lat, color=factor(cluster, labels = c("High Income, Low Assault Count", "High Assault Count", "Low Income, Low Assault Count"))), size=1) +
xlab(expression(paste("Longitude (", degree,"W)"))) +
ylab(expression(paste("Latitude (", degree,"N)"))) +
labs(color = "Clusters") +
ggtitle("Assaults Clustered by Subdivision (2020)")
# Total Theft
set.seed(123)
kclusts <-
tibble(k = 1:9) %>%
mutate(
kclust = map(k, ~kmeans(df.18.v2.TotTh, .x)),
tidied = map(kclust, tidy),
glanced = map(kclust, glance),
augmented = map(kclust, augment, df.18.v2.TotTh)
)
clusters <-
kclusts %>%
unnest(cols = c(tidied))
assignments <-
kclusts %>%
unnest(cols = c(augmented))
clusterings <-
kclusts %>%
unnest(cols = c(glanced))
p1 <-
ggplot(assignments, aes(x = Avg.Inc, y = Total.Theft)) +
geom_point(aes(color = .cluster), alpha = 0.8) +
facet_wrap(~ k)
p2 <- p1 + geom_point(data = clusters, size = 10, shape = "x")
p2
ggplot(clusterings, aes(k, tot.withinss)) +
geom_line() +
geom_point()
df.18.v2.TotTh.final <- kmeans(df.18.v2.TotTh, centers=3, nstart=25)
str(df.18.v2.TotTh.final)
df.19.v2.TotTh.final <- kmeans(df.19.v2.TotTh, centers=3, nstart=25)
str(df.19.v2.TotTh.final)
df.20.v2.TotTh.final <- kmeans(df.20.v2.TotTh, centers=3, nstart=25)
str(df.20.v2.TotTh.final)
# Year: 2018
df.18.v2.TotTh.Prescale <- as.data.frame(df.18.v2.TotTh.Prescale)
df.18.v2.TotTh.Prescale %>%
mutate(Cluster = df.18.v2.TotTh.final$cluster) %>%
group_by(Cluster) %>%
summarise_all("mean")
dfX.18 <- data.frame('div_id' = names(df.18.v2.TotTh.final$cluster), 'cluster'=df.18.v2.TotTh.final$cluster)
rownames(dfX.18) <- NULL
# Year: 2019
df.19.v2.TotTh.Prescale <- as.data.frame(df.19.v2.TotTh.Prescale)
df.19.v2.TotTh.Prescale %>%
mutate(Cluster = df.19.v2.TotTh.final$cluster) %>%
group_by(Cluster) %>%
summarise_all("mean")
dfX.19 <- data.frame('div_id' = names(df.19.v2.TotTh.final$cluster), 'cluster'=df.19.v2.TotTh.final$cluster)
rownames(dfX.19) <- NULL
# Year: 2020
df.20.v2.TotTh.Prescale <- as.data.frame(df.20.v2.TotTh.Prescale)
df.20.v2.TotTh.Prescale %>%
mutate(Cluster = df.20.v2.TotTh.final$cluster) %>%
group_by(Cluster) %>%
summarise_all("mean")
dfX.20 <- data.frame('div_id' = names(df.20.v2.TotTh.final$cluster), 'cluster'=df.20.v2.TotTh.final$cluster)
rownames(dfX.20) <- NULL
# Join on div_id to add cluster by each subdivision
# Year: 2018
df.18.theft <- df.18 %>% filter(offensecategory == "Larceny" | offensecategory == "Stolen Property" | offensecategory == "Motor Vehicle Theft")
df.18.theft$div_id <- as.character(df.18.theft$div_id)
df.18.theft <- left_join(df.18.theft, dfX.18, by='div_id')
# Year: 2019
df.19.theft <- df.19 %>% filter(offensecategory == "Larceny" | offensecategory == "Stolen Property" | offensecategory == "Motor Vehicle Theft")
df.19.theft$div_id <- as.character(df.19.theft$div_id)
df.19.theft <- left_join(df.19.theft, dfX.19, by='div_id')
# Year: 2020
df.20.theft <- df.20 %>% filter(offensecategory == "Larceny" | offensecategory == "Stolen Property" | offensecategory == "Motor Vehicle Theft")
df.20.theft$div_id <- as.character(df.20.theft$div_id)
df.20.theft <- left_join(df.20.theft, dfX.20, by='div_id')
# Total thefts
# Year: 2018
(map <- get_map(c(left = -78.95, bottom = 35.64, right = -78.72, top = 35.87)))
ggmap(map) +
geom_point(data=df.18.theft, aes(x=lon, y=lat, color=factor(cluster, labels = c("Low Income, Low Theft Count", "High Theft Count", "High Income, Low Theft Count"))), size=1) +
xlab(expression(paste("Longitude (", degree,"W)"))) +
ylab(expression(paste("Latitude (", degree,"N)"))) +
labs(color = "Clusters") +
ggtitle("Thefts Clustered by Subdivision (2018)")
# Year: 2019
(map <- get_map(c(left = -78.95, bottom = 35.64, right = -78.72, top = 35.87)))
ggmap(map) +
geom_point(data=df.19.theft, aes(x=lon, y=lat, color=factor(cluster, labels = c("High Theft Count", "Low Income, Low Theft Count", "High Income, Low Theft Count"))), size=1) +
xlab(expression(paste("Longitude (", degree,"W)"))) +
ylab(expression(paste("Latitude (", degree,"N)"))) +
labs(color = "Clusters") +
ggtitle("Thefts Clustered by Subdivision (2019)")
# Year: 2020
(map <- get_map(c(left = -78.95, bottom = 35.64, right = -78.72, top = 35.87)))
ggmap(map) +
geom_point(data=df.20.theft, aes(x=lon, y=lat, color=factor(cluster, labels = c("High Income, Low Theft Count", "Low Income, Low Theft Count", "High Theft Count"))), size=1) +
xlab(expression(paste("Longitude (", degree,"W)"))) +
ylab(expression(paste("Latitude (", degree,"N)"))) +
labs(color = "Clusters") +
ggtitle("Thefts Clustered by Subdivision (2020)")
crimesPerDivision<-crimesLeftJoined  %>% as_tibble()%>% dplyr::select(name,crime_category) %>% count(name, crime_category) %>% pivot_wider(names_from = crime_category, values_from=n)%>% replace(is.na(.), 0)
divWithCrimes <-left_join(div, crimesPerDivision ) %>% as_tibble() %>% dplyr::select(-starts_with ("shape")& -starts_with("geo"))
divWithCrimesDummy<-divWithCrimes%>% dummy_columns(select_columns = "description")
res.PCA <- PCA(divWithCrimesDummy %>% dplyr::select(-category & -description&-name))
fviz_screeplot(res.PCA)
plot.PCA(res.PCA, choix="varcor", autoLab="auto")
plot.PCA(res.PCA, choix="ind",habillage='ind', select='contrib  10',title="Barycenters", cex=.9)
pca_var_cor = res.PCA$var$cor[,1]
pca_var_contrib= res.PCA$var$contrib[,1]
df_dim1 = data.frame( pca_var_cor, pca_var_contrib)
df_dim1 %>% ggplot(aes(x=pca_var_contrib, y=pca_var_cor, label=rownames(df_dim1))) +
ggtitle("Dim 1 - Variables Correlations-Explained Covariance") +
xlab("% Explained Covariance") + ylab("correlation to Dim 1") +
geom_point() + geom_text_repel()
pca_var_cor = res.PCA$var$cor[,2]
pca_var_contrib= res.PCA$var$contrib[,2]
df_dim2 = data.frame( pca_var_cor, pca_var_contrib)
df_dim2 %>% ggplot(aes(x=pca_var_contrib, y=pca_var_cor, label=rownames(df_dim2))) +
ggtitle("Dim 2 - Variables Correlations-Explained Covariance") +
xlab("% Explained Covariance") + ylab("correlation to Dim 2") +
geom_point() + geom_text_repel()
fviz_pca_ind(res.PCA, label="none",habillage = "description_Townhome")
fviz_pca_ind(res.PCA, label="none", habillage = "description_Single-Family Detached")
g = lm(div$shape_starea ~ div$approvedlots )
summary(g)
div[which(div$approvedlots == 0), ] %>% dplyr::select(div_id, name, shape_starea, approvedlots)
div$approvedlots[414] = 11   # Arrington Woods  Condo
div$approvedlots[419] = 33   # Summercrest Two Single Family Detached
div$approvedlots[706] = 573  # Searstone Mixed residential
impute_approvedlots = data.frame(name = c("Arrington Woods", "Summercrest Two", "Searstone" ),
category = c("Condo", "Single Family Detached", "Mixed Residential") ,
approvedlots = c( 11, 33, 573 ) )
impute_approvedlots %>% kable(caption="Residential Subdivisions with Imputed Approved Lots") %>% kable_styling( bootstrap_options = c("striped", "hover"))
ggplot(data=div) + geom_point(aes(x=approvedlots, y=shape_starea)) + facet_wrap(~category) + ggtitle("Approved Lots vs. Land Area by Subdivision")
div[which(div$name == "Brickyard"),]$category = "Townhome"  # Manually checked that Brickyard is a townhome subdivision and category is NA
table(div$category, useNA='ifany') %>% kable() %>% kable_styling(bootstrap_options = c("striped", "hover"))
# Save the crime counts by year and residential subdivision
# Fill the NA values (i.e. no crimes in year X in subdivision R with 0)
# -------------------------------------------
divfreq = crimesdiv %>% group_by(div_id, year) %>% summarize( count = n()) %>%
st_drop_geometry() %>%
pivot_wider(names_from = year, values_from = count, values_fill = 0  )
regdivdata = div %>% left_join(divfreq, by="div_id") %>% mutate( `2018` = coalesce(`2018`, 0), `2019` = coalesce(`2019`, 0 ), `2020` = coalesce(`2020`, 0 ) )
regdivdata = regdivdata %>% mutate( cr2018 = `2018`/approvedlots, cr2019 = `2019`/approvedlots, cr2020 = `2020`/approvedlots)
#head(regdivdata) %>% kable() %>% kable_styling(bootstrap_options = c("striped", "hover,"))
regdivdata %>% dplyr::select(div_id, `2018`, `2019` , `2020`) %>% st_drop_geometry() %>% pivot_longer(!div_id, names_to="year", values_to="count" ) %>% ggplot() + geom_density(aes(x=count, fill=year), alpha = 0.3) +
ggtitle("Density of Crimes by Annual Count 2018-2020")
qtm2018 = qtm(regdivdata, "2018") + tm_grid(alpha=0.3)
qtm2019 = qtm(regdivdata, "2019") + tm_grid(alpha=0.3) + tm_compass()
qtm2020 = qtm(regdivdata, "2020") + tm_scale_bar(position=c("center", "bottom" ) ) + tm_grid(alpha=0.3) +
tm_credits("Crime Counts \n per \n Residential\n Subdivision\n per Year\nCary, NC" , position=c("left", "center"), width=0.25, align="left" )
qtm2018
qtm2019
qtm2020
#tmap_arrange(qtm2018, qtm2019, qtm2020, asp = 1.5, ncol = 1)
#gm1 = lm( cr2019 ~ cr2018 + avg_income + approvedlots + shape_starea + factor(category), data = regdivdata)
OLS2 = lm( `2019` ~ `2018` + avg_income + approvedlots + shape_starea + factor(category), data = regdivdata)
summary(OLS2)
c_div = st_centroid( st_geometry(div))
k6 = knn2nb( knearneigh(st_centroid( st_geometry(div)), k = 6), row.names = div$div_id)
k6.weights = nb2listw(k6)
wts_k6_a2 = nb2listwdist(k6, c_div, type = "idw", style="W", alpha=0.5)
#summary(wts_k6_a2)
#k4 = knn2nb( knearneigh(st_centroid( st_geometry(div)), k = 4), row.names = div$div_id)
#k4.weights = nb2listw(k4)
#wts_k4_a2 = nb2listwdist(k4, c_div, type = "idw", style="W", alpha=0.5)
#k3 = knn2nb( knearneigh(st_centroid( st_geometry(div)), k = 3), row.names = div$div_id)
#k2.weights = nb2listw(k3)
#wts_k3_a2 = nb2listwdist(k6, c_div, type = "idw", style="W", alpha=0.5)
# diagram of the spatial weights linkages.
#
plot(wts_k6_a2, c_div, lwd = .5, col = "red", cex = 0.5)
lm.LMtests(OLS2, wts_k6_a2, test = c("LMlag", "LMerr"))
moran.test( regdivdata$`2019`, wts_k6_a2)
moran.plot( regdivdata$`2019`, wts_k6_a2)
spatial.lag.k6a2 = lagsarlm( `2019` ~ `2018` + avg_income + approvedlots + shape_starea + factor(category),
data = regdivdata , wts_k6_a2 )
summary(spatial.lag.k6a2)
OLS2
OLS2$xlevels
plot(OLS2$coefficients)
barplot(OLS2$coefficients)
