---
title: "Data 622 Homework 4: ADHD/Suicide Study"
author: "Group 6: Alexander Ng, Scott Reed, Philip Tanofsky, Randall Thompson"
date: "Submitted by 05/07/2021"
output:
  html_document:
    df_print: paged
    highlight: pygments
    number_sections: yes
    theme: readable
    toc: yes
    toc_depth: 3
    toc_float: no
    fontsize: 12
  pdf_document:
    toc: yes
    toc_depth: '3'
    number_sections: true
    df_print: kable
    highlight: tango
editor_options:
  chunk_output_type: inline
fontsize: 11pt
urlcolor: blue
---

```{r setup, include=FALSE}
# Your libraries go here

library(tidyverse)
library(ggplot2)
library(knitr)
library(kableExtra)
library(dplyr)
library(readxl)

library(caret)    # Model Framework
library(skimr)    # Used for EDA
library(klaR)     # Implemented KNN and Naive Bayes models, etc
library(class)    # used for KNN classifier

# PLEASE ADD YOUR R LIBRARIES BELOW
# ------------------------------

# ---------------------------------
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)

```

```{r control-slow-code}
# Alex:
# This code chunk is only to be used for conditionally disabling certain
# very slow model code as I merge different sections and need to frequent recompile
runSlowChunks = F

```




# Introduction {-}

This document discusses analyses of a mental health data set.  

**Section 1** conducts exploratory data analysis and data wrangling on the dataset.  
We obtain a dataset with imputed values and omitted rows and columns. The author is Alexander Ng.

**Section 2** contains an analysis with hierarchical clustering and k-means analysis. The author is Alexander Ng (primary).

**Section 3** contains an analysis using a multiple factor analysis (MFA) which is a generalization of principal components analysis (PCA).  The author is Alexander Ng.

**Section 4** contains an analysis using a support vector machine (SVM) approach using suicide as the response variable.  The authors are Philip Tanofsky and Scott Reed.

**Section 5** contains a supplementary analysis using binary logistic regression as a baseline model to evaluate the SVM results and contains additional conclusions.   The author is Randall Thompson.

**Section 6** presents our `R` code and technical appendices and references.   The document was merged and edited by $\color{red}{\text{TBD}}$.

# Exploratory Data Analysis

We load the data using the `readxl` package which is part of `tidyverse`.  This package allows us to do __name repair__ to the column headers
of the Excel spreadsheet.  Using `.name_repair` equal to `universal`, we transform all column names with spaces or special characters into better named
counterparts.   For example, `Hx of Violence` is transformed into `Hx.of.Violence` and `MD Q1k` into `MD.Q1k`.


```{r excel-load}

# Load the raw data
raw_a = read_excel("ADHD_data.xlsx", sheet = 1, .name_repair = "universal")

# Load the data dictionary
b = read_excel("ADHD_data.xlsx", sheet = 2 )

```


The original dataframe contains 175 observations (i.e. survey participants) as rows and 54 columns as variables.
```{r raw-dimensions}
dim(raw_a)

```

The columns contain both qualitative and quantitative variables.   
Moreover, some columns represent categorical data but is encoded as numerical values.

Thus, we will perform 4 data transformations to obtain a cleansed and fully populated dataframe:

1. Removal of observations with significant data issues
2. Remove of columns where data is meaningless or missing excessive values.
3. Imputation of missing values in those columns where business analysis allows sensible choices.
4. Rescaling or conversion of data to factor or character values.

In the final section, we make several demographic comparisons about the data to the general populations of the US.

## Missing Data Treatment

### Removal of Observations

Four observations had missing values for `Alcohol`.  But those observations also have a large number of correlated missing data columns as shown below.
Excluding these 4 observations eliminate missing data for 6 columns and undefined values for several other variables.
Thus, we retain 97.7% (or 171) of the original observations.

```{r}

raw_a %>% filter( is.na(Alcohol)) %>% 
  dplyr::select(Initial, 
                Alcohol, THC, Cocaine, Stimulants, 
                Sedative.hypnotics, Opioids, 
                Court.order, Education, 
                Hx.of.Violence, Disorderly.Conduct, 
                Suicide, Abuse, 
                Non.subst.Dx, Subst.Dx, 
                MD.TOTAL, 
                ADHD.Total, 
                Age, 
                Race, 
                Sex)

```


```{r remove-observations}

a <- raw_a %>% filter(!is.na(Alcohol))

```

## Removing Columns

We remove columns `Initial`, `Psych.meds.` because they have no useful information or have over 50% missing values.


```{r remove-columns}
dim(a)

a <- a %>% dplyr::select(-any_of(c("Initial", "Psych.meds.")))

dim(a)

```

## Imputing Values

We explain our decisions on the handling of the remaining imputed values here.

```{r skim}

skim(a) %>% dplyr::filter( n_missing > 0 )

```

### Abuse

There are only 10 remaining observations with missing Abuse data.   As we see below, the most frequent response is 0 -- i.e. No.

```{r abuse-plot}

barplot(table(a$Abuse, useNA = 'ifany') , 
        xlab='Abuse Scale', ylab = 'Count', 
        main="Frequency of Abuse responses" )

```

Moreover, the conditional distribution of survey response score `ADHD.Total` and `MD.TOTAL` seems unchanged for this subpopulation.
So we make the imputation.

```{r abuse-impact}
# Examine missing column values by comparing values of other variables.
# to check if the observations may be considered atypical.
# -----------------------------------------------------------------
missing_Abuse = a %>% filter(is.na(Abuse))

print(paste0("Conditional Mean ADHD.Total: " , mean(missing_Abuse$ADHD.Total)  , " Population Mean ADHD.Total: ", mean(a$ADHD.Total) ) )
print(paste0("Conditional Mean MD.Total: ", mean( missing_Abuse$MD.TOTAL)  ,  " Population Mean MD.TOTAL: ", mean(a$MD.TOTAL) ) )

```

### Suicides

We choose to impute Suicide=0 for those observations where Suicide is not defined.
The number of incidents is low, the most common response is 0 (No) and the conditional mean of ADHD.Total and MD.Total
is unchanged for this subpopulation.

```{r impute-suicides}

suicide_tab = table(a$Suicide, useNA = 'ifany')


barplot(suicide_tab, 
        xlab='Attempted Suicide Response 0=No', ylab = 'Count', 
        main="Frequency of Attempted Suicide responses" )


missing_suicide = a %>% filter(is.na(Suicide))

print(paste0("Conditional Mean ADHD.Total: " , mean(missing_suicide$ADHD.Total)  , " Population Mean ADHD.Total: ", mean(a$ADHD.Total) ) )
print(paste0("Conditional Mean MD.Total: ", mean( missing_suicide$MD.TOTAL)  ,  " Population Mean MD.TOTAL: ", mean(a$MD.TOTAL) ) )

```

### History of Violence and Disorderly Conduct

The non-responses for History of Violence and Disorderly conduct are perfectly correlated in our dataset.
Also, because the questions are so conceptually linked, we consider the frequency table of their
joint distribution.   As we see below, the most frequent scenario is `Disorderly Conduct` = ` while 
`History of Violence` = 0 twice as frequently as any other scenario.

Moreover, the conditional mean of `ADHD.Total` and `MD.TOTAL` is unaffected for this subpopulation.


```{r violence-disorder-impute}

table(a$Hx.of.Violence, a$Disorderly.Conduct, useNA='ifany') %>% kable(main="Frequency of Violence/Disorderly Conduct") %>% 
  add_header_above(c("Disorderly Conduct" = 4)) %>% kable_styling(bootstrap_options = c("striped", "hover")) %>%
  footnote(general="Each row shows counts for History of Violence 0=No, 1=Yes")


missing_disorderly = a %>% filter(is.na(Disorderly.Conduct))

print(paste0("Conditional Mean ADHD.Total: " , mean(missing_disorderly$ADHD.Total)  , " Population Mean ADHD.Total: ", mean(a$ADHD.Total) ) )
print(paste0("Conditional Mean MD.Total: ", mean( missing_disorderly$MD.TOTAL)  ,  " Population Mean MD.TOTAL: ", mean(a$MD.TOTAL) ) )


```

## Transforming Variables

In this section, we apply the above data imputation rules to the variables with missing values.
Next, we construct factor equivalent variables with the naming convention of a `f` prefix to any abbreviated version of the original variable name.
Lastly, we remove the older version of the columns with their factor equivalent.

A table below shows the translation from old to new variables along with the range of permitted values.


```{r}

#  Use case_when to convert numeric flags to character equivalent qualitative variables
#  Note that NA are automatically assigned by default if encountered by case_when
#  so handling of NA is implicit.
#

a %>% mutate(
             Abuse  = case_when( is.na(Abuse) ~ 0 ,       # Based on data imputation investigation above
                                 !is.na(Abuse) ~ Abuse ) ,
             
             Suicide = case_when( is.na(Suicide) ~ 0 ,  # Suicide attempts are generally rare  - this imputed value is most common
                                  !is.na(Suicide) ~ Suicide
                                  ) ,
             Hx.of.Violence = case_when( is.na(Hx.of.Violence) ~  0 , # Most common cose is no history of violence)
                                        !is.na(Hx.of.Violence) ~ Hx.of.Violence ) ,
             
             Disorderly.Conduct = case_when( is.na(Disorderly.Conduct) ~ 1 ,  # Most common case is to exhibit disorderly conduct - even conditional on no history of violence
                                             !is.na(Disorderly.Conduct) ~ Disorderly.Conduct
                                             ) ,
             
             Court.order = case_when( is.na( Court.order) ~ 0 ,   # Most common case
                                      !is.na( Court.order) ~ Court.order )   ,
             
             Education = case_when( is.na( Education ) ~ 12 ,  # Most common case
                                    !is.na( Education)  ~ Education
                                    ) ,
             
             Non.subst.Dx = case_when( is.na(Non.subst.Dx) ~ 0 , # Most common case
                                       !is.na( Non.subst.Dx) ~ Non.subst.Dx ) ,
             
             Subst.Dx = case_when( is.na( Subst.Dx ) ~ 3 , # Treat NA as a distinct category
                                   !is.na( Subst.Dx) ~ Subst.Dx )
                                   
        
             
             ) %>%
       mutate(fSex = case_when( Sex == 1 ~ "M", 
                               Sex == 2 ~ "F" ) ,
             fRace = case_when(
                  Race == 1 ~ "WH" ,
                  Race == 2 ~ "AF" ,
                  Race == 3 ~ "HI" ,
                  Race == 4 ~ "AS" ,
                  Race == 5 ~ "NA" ,
                  Race == 6 ~ "OT"
              ) ,
             fCO = case_when(Court.order == 0 ~ "No" ,
                             Court.order == 1 ~ "Yes") ,
             fHViol = case_when( Hx.of.Violence == 0 ~ "No",
                                 Hx.of.Violence == 1 ~ "Yes") ,
             fDCond = case_when( Disorderly.Conduct == 0 ~ "No" ,
                                 Disorderly.Conduct == 1 ~ "Yes") ,
             fSuic  = case_when( Suicide == 0 ~ "No" ,
                                 Suicide == 1 ~ "Yes")  ,
             
             fNonDx =  as.factor(Non.subst.Dx)  ,
             
             fSubsDx = as.factor(Subst.Dx) ,
             
             fAbuse = factor(Abuse, ordered = TRUE)   # No way to make the Abuse variable into a non-skewed scaled variable
       ) %>% 
      dplyr::select( -one_of(c("Psych.meds.", "Initial", 
                               "Sex", "Race", "Court.order", "Hx.of.Violence", "Disorderly.Conduct" ,
                               "Suicide", "Non.subst.Dx", "Subst.Dx", "Abuse")) )-> aa




```

Note the following transformation from the original variable to the new one as follows:


```{r convert-vars}

df = data.frame(OldVar = c("Sex" , "Race" , "Court.order", "Abuse", "Hx.of.Violence", "Disorderly.Conduct", "Suicide", "Non.subst.Dx", "Subst.Dx") ,
                NewVar = c("fSex", "fRace", "fCO",        "fAbuse", "fHViol",       "fDCond",               "fSuic" , "fNonDx" ,       "fSubsDx" ) ,
                Range  =  c("M,F",   "WH,AF,HI,AS,NA,OT", "Yes,No" , "0-7 (factor)", "Yes,No" ,   "Yes,No", "Yes,No", "0,1,2 (factor)", "0,1,2,3 (factor)" ) )

df %>% kable(caption="Conversion of Old Variables to New") %>% kable_styling(bootstrap_options = c("hover", "striped"))
```

## Exporting the New Data Set

We export the dataset for reference purposes.

```{r export-aa}

write_csv(aa, "New_adhd.csv")

```


```{r}

new_col_order = c(

                  "Age" ,
                  "Education",
                  
                  "fAbuse" ,
                  "fCO" ,
                  "fHViol" ,
                  "fDCond" ,
                  "fSuic"  ,
                  
                  "fNonDx" ,
                  "fSubsDx" ,
                  
                  "ADHD.Q1",
                  "ADHD.Q2",
                  "ADHD.Q3",            "ADHD.Q4",            "ADHD.Q5",            "ADHD.Q6",   
                  "ADHD.Q7",            "ADHD.Q8",            "ADHD.Q9"  ,          "ADHD.Q10", 
                  "ADHD.Q11",           "ADHD.Q12",           "ADHD.Q13",           "ADHD.Q14", 
                  "ADHD.Q15",           "ADHD.Q16",           "ADHD.Q17",           "ADHD.Q18",     
                  "ADHD.Total", 
                  
                  "MD.Q1a",             "MD.Q1b",             "MD.Q1c",            
                  "MD.Q1d",             "MD.Q1e",             "MD.Q1f",             "MD.Q1g",            
                  "MD.Q1h",             "MD.Q1i",             "MD.Q1j",             "MD.Q1k" ,           
                  "MD.Q1L",             "MD.Q1m",             "MD.Q2",             "MD.Q3",             
                  "MD.TOTAL" ,
                  
                  "Alcohol",
                  "THC" ,
                  "Cocaine" ,
                  "Stimulants" ,
                  "Sedative.hypnotics" ,
                  "Opioids" ,
                  
                  "fSex", 
                  "fRace" 
                  )

ab = aa[, new_col_order]

skim(ab)

```


## The Survey Is Not Representative of the US Population

Because the dataset is anonymized, we have no background context of the study's location, purpose and population.
Comparisons with available data sources suggest that the survey population is highly non-representative by gender, race,
educational attainment or history of violence of the US general population.  We present evidence for each discrepancy in turn.

Consequently, we should not apply statistics inferences and machine learning predictions from the dataset and our models to the general US population.   The researcher needs to condition any inferences on the intended and true population.

### Education

The Educational attainment of the survey population is below US average.
US Census data shows US population 18 years and older have graduated high school or better is 89%.
By comparison, in our sample only 68% have graduated high school or better.   (We use the 18 years and older population to match the observed age range in the sample.)   The below table shows the frequency of educational attainment by years of education within the survey population.

```{r education-low}
(tab_education = table(aa$Education, useNA='ifany') )
```

Summing up the count of those with 11 years or less of education, we obtain the figure:

```{r education-hsgrad}
(hsgrad = 1 - sum(tab_education[1:6]) / sum(tab_education))

```

Below we show the US Census trend for educational attainment about adults 24 and older.  The 18 years and older population is contained in the underlying Excel spreadsheet, however.

<a href="https://www.census.gov/library/visualizations/2017/comm/americas-education.html?cid=americas-education" target="_blank"><img src="https://www.census.gov/library/visualizations/2017/comm/americas-education/_jcr_content/map.detailitem.950.high.jpg/1513289287771.jpg" alt="America's Education: Population Age 25 and Over by Educational Attainment" width="648" height="648" title="America's Education: Population 25 and Over by Educational Attainment"/></a>[Source: U.S. Census Bureau]


### Gender

The gender within the survey population is heavily skewed towards males at 56.6% instead of 49.1% as in the general population.

```{r gender-breakdown}
freq_sex = table(aa$fSex)

freq_sex = rbind( freq_sex / nrow(aa)) * 100

freq_sex %>% kable(digits = 1, caption="Percentage by Gender" )
```

### Race

The survey population is not representative of the racial composition of the US.  

```{r racial-breakdown}

race_freq = table(aa$fRace)
race_freq = rbind(race_freq, race_freq/nrow(aa)*100)

race_freq %>% kable(digits = 1) %>% kableExtra::kable_styling(bootstrap_options = c("striped", "hover"))

```
The US Census Bureau shows Whites are 76.3%,  Blacks are 13.4%, Hispanics are 18.5%, Asians are 5.9%, American Indian are 1.3% according to 2019 data available on [this link](https://www.census.gov/quickfacts/fact/table/US/PST045219).

We conclude the Blacks are overrepresented in the survey 57.1% (survey) vs. 13.4% (census), Whites are underrepresented 41.1% (survey) vs. 76.3%.  Hispanics are underrepresented 0.6% (survey) vs. 18.5% (census) and Asians are not represented at all 0% (survey) vs. 5.9% (census).


# Multiple Factor Analysis - A Generalization of PCA

Multiple Factor analysis is a generalization of PCA that allows the combined use of quantitative variables and qualitative variables in a single analysis.   Its aim is similar to that of principal components analysis.  But whereas PCA does not allow qualitative variables, MFA allow them by combining two techniques:  PCA for quantitative variables and Multiple Correspondence Analysis (MCA) for qualitiative variables.   The key contribution of MFA is to systematically group variables as: `active` or `supplementary` and to assign a weight to the contribution of each group of variables to the final output.   The key authors of the textbook explaining the MFA approach and the software package `FactoMineR` and `FactoShiny`  are French: Jerome Pages and Francois Husson, "Multiple Factor Analysis by Example Using R" and the [FactoMineR website](http://factominer.free.fr/) contains the required software.
   

```{r}

select_cols = c("fSex", "fRace", "Age", "Education", "Alcohol", "THC", "Cocaine",
                "Stimulants", "Sedative.hypnotics", "Opioids", "fCO", "fHViol" , "fDCond" ,
                "fSuic" , "fNonDx" , "fSubsDx" , "fAbuse" , "ADHD.Total" , "MD.Q3" ,
                "MD.TOTAL" )


test_cols = c("fSex", "fRace", "Age", "Education",  "fCO", "fHViol" , "fDCond" ,
                "fSuic" , "fNonDx" , "fSubsDx" , "fAbuse" , "ADHD.Total" ,  "MD.TOTAL" )

ab_test = ab[, test_cols ]

ab_lesscols = ab[,select_cols ]

colnames(ab_lesscols)

```

## FactoMineR MFA Analysis

```{r factorminer-load}
library(FactoMineR)
library(factoextra)

```

We run a MFA analysis using a smaller set of data and variables.   First we using only 14 variables divided into 5 groups.

The groups and their member variables are listed below:

   1.  **SexRace**  fSex,  fRace    __qualitative__
   2.  **AgeEdu**    Age, Education __quantitative__ ,  __scaled__
   3.  **Vio**       fCO,  fHViol,  fDCond, fSuic  __qualitative__
   4.  **Dx**          fNonDx,  fSubsDx  __quantitative__, __scaled__
   5.  **Mood**      Abuse,  ADHD.Total,  MD.TOTAL  __quantitative__, __scaled__

```{r}

newDF <- ab_test[,c("fSex","fRace","Age","Education","fCO","fHViol","fDCond","fSuic","fNonDx","fSubsDx","fAbuse","ADHD.Total","MD.TOTAL")]
res.MFA<-MFA(newDF,group=c(2,2,4,2,1,2), type=c("n","s","n","n","n", "s"),name.group=c("SexRace","AgeEdu","Vio","Dx","Abuse", "Mood"),graph=FALSE)
```

```{r}
plot.MFA(res.MFA, choix="ind",lab.par=TRUE,invisible= c('quali','quali.sup'),select='contrib  53',habillage='fSuic',title="Individual factor map",cex=0.85,cex.main=0.85,cex.axis=0.85)
```

The above plot overlays Suicide on the individual observations in the MFA plot of first and second MFA dimensions.  These two axes have the highest explanatory power of the data variance.   It shows that the majority of Suicide = Yes reports occurs in the upper right hand quadrant.  This means the MFA axes do a good job of separating the Suicide and non-Suicide patients using an MFA analysis.


```{r}
plot.MFA(res.MFA, choix="var",select='contrib 7',habillage='group',title="Correlation circle",cex=1.15,cex.main=1.15,cex.axis=1.15)
plot.MFA(res.MFA, choix="group",cex=1.35,cex.main=1.35,cex.axis=1.35)
plot.MFA(res.MFA, choix="axes",ncp=3,habillage='group')



```
## MFA

Do an MFA analysis on the complete

```{r}

amfa1 = ab %>% dplyr::select( -one_of("ADHD.Total", "MD.TOTAL") )

colnames(amfa1)

```


# Appendices

## References

Abdi, Hervé, and Lynne J. Williams. 2010. “Principal Component Analysis.” John Wiley and Sons, Inc. WIREs Comp Stat 2: 433–59
(http://staff.ustc.edu.cn/~zwp/teach/MVA/abdi-awPCA2010.pdf)


[MFA - Multiple Factor Analysis]
(http://www.sthda.com/english/articles/31-principal-component-methods-in-r-practical-guide/116-mfa-multiple-factor-analysis-in-r-essentials)


Multiple Factor Analysis Playlist for using FactoMineR
(https://www.youtube.com/playlist?list=PLnZgp6epRBbRX8TEp1HlFGqfMf_AxYEj7)

## Code

We summarize all the R code used in this project in this appendix for ease of reading.


#```{r ref.label=knitr::all_labels(), echo=T, eval=F}
#```


